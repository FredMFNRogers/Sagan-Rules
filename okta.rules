##OKTA USER ATTEMPTED UNAUTHORIZED ACCESS TO AN APPLICATION
alert any any any -> any any (msg: "[OKTA] USER ATTEMPTED UNAUTHORIZED ACCESS TO AN APPLICATION"; content:"User attempted unauthorized access to app"; normalize; parse_proto; parse_port; parse_src_ip: 1; parse_dst_ip: 2; default_proto: tcp; classtype: network-event; threshold: type suppress, track by_src, count 1, seconds 300; reference: url,https://developer.okta.com/docs/reference/api/event-types/; sid:XXXXX; rev:1;)
##Auto Comment: 'An attempted unauthorized access for the application "XXX_displayName1_XXX"was observed for the user "XXX_alternateId2_XXX" from source <ip>SRCIP</ip> [XXX_city_XXX , XXX_country_XXX] with a risk level of "XXX_risk_XXX". Quadrant recommends determining if this is someone trying to bypass security restrictions or if this is related to a permissions configuration issue within Okta.
##Signature Playbook: 'This rule is designed to trigger once per five minutes by source IP on a user trying to access an application for which they do not have asssigned permissions. This can be due to a misconfiguration or can be an attempt at accessing sensitive material by someone who is not privy to that information. This alert is mostly for correlation purposes and to notify the client of a potential issue with their permissions settings. The following variables in these logs can also be very helpful in determining how serious of a threat this could be: "New Geo-Location=NEGATIVE, New Device=NEGATIVE, New IP=NEGATIVE, New State=NEGATIVE, New Country=NEGATIVE, Velocity=NEGATIVE, New City=NEGATIVE".'
##Sample Logs:
##{"version":"0","uuid":"8675309-8675309-8675309-8675309","transaction":{"type":"WEB","id":"8675309"},"target[0]":{"type":"AppInstance","id":"8675309","displayName":"APPLICATION_NAME","alternateId":"APPLICATION_NAME_ALTERNATE"},"severity":"WARN","securityContext":{"isp":"INTERNET_SERVICE_PROVIDER","isProxy":"false","domain":".","asNumber":"1337"},"request":{"ipChain[0]":{"version":"V4","ip":"8.8.8.8","geographicalContext":{"state":"STATE","postalCode":"1337","geolocation":{"lon":"XX.XXXXX","lat":"XX.XXXXX"},"country":"COUNTRY","city":"CITY"}}},"published":"2022-06-13T14:34:45.592Z","outcome":{"result":"FAILURE"},"legacyEventType":"app.generic.unauth_app_access_attempt","eventType":"app.generic.unauth_app_access_attempt","displayMessage":"User attempted unauthorized access to app","debugContext":{"debugData":{"url":"/login/step-up/redirect?stateToken=8675309-8675309","risk":"{level=LOW}","requestUri":"/login/step-up/redirect","requestId":"8675309","behaviors":"{New Geo-Location=NEGATIVE, New Device=NEGATIVE, New IP=NEGATIVE, New State=NEGATIVE, New Country=NEGATIVE, Velocity=NEGATIVE, New City=NEGATIVE}"}},"client":{"zone":"null","userAgent":{"rawUserAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.63 Safari/537.36","os":"Windows 10","browser":"CHROME"},"ipAddress":"8.8.8.8","geographicalContext":{"state":"STATE","postalCode":"1337","geolocation":{"lon":"XX.XXXXX","lat":"XX.XXXXX"},"country":"COUNTRY","city":"CITY"},"device":"Computer"},"authenticationContext":{"authenticationStep":"0"},"actor":{"type":"User","id":"8675309","displayName":"FIRSTUSER SURNAME","alternateId":"USER_PRINCIPAL_NAME"},"SOURCE":"s_okta-system-log","PROGRAM":"okta-system-log_relayer","HOST_FROM":"example.host","HOST":"example.host"}

##OKTA INBOUND REQUEST FROM BLACKLISTED IP
alert any any any -> any any (msg: "[OKTA] INBOUND REQUEST FROM A BLACKLISTED IP"; content:"Blacklisted request from "; normalize; parse_proto; parse_port; parse_src_ip: 1; parse_dst_ip: 2; default_proto: tcp; classtype: network-event; threshold: type suppress, track by_src, count 1, seconds 7200; reference: url,https://help.okta.com/en/prod/Content/Topics/Security/healthinsight/blocklist-network-zone.htm; sid:XXXXX; rev:1;)
##Auto Comment: 'An inbound request to "XXX_requestUri_XXX" was observed from the blacklisted source <ip>SRCIP</ip>. This request was made by the user "XXX_alternateId_XXX" and was blocked due to "XXX_reason_XXX". This is an informational alert.'
##Signature Playbook: 'This rule was designed to trigger once per two hours by source IP on inbound requests from blacklisted IPs to the Okta server. If the outcome variable is something other than "SUCCESS" indicating the traffic was indeed blocked, the line "This is an informational alert" should be changed to "Quadrant recommends determining why this request was not properly blocked". Remember to include any correlated logs that may be found on the PIE sensor for the referenced IP if this is the case.'
##Sample Logs:
##okta_system_log-19700101.log:{"version":"0","uuid":"8675309-8675309-8675309-8675309","transaction":{"type":"WEB","id":"8675309"},"severity":"WARN","request":{"ipChain[0]":{"version":"V4","ip":"8.8.8.8"}},"published":"1970-01-01T08:28:26.988Z","outcome":{"result":"SUCCESS","reason":"NETWORK_ZONE_BLACKLIST"},"legacyEventType":"security.zone.request.blocked","eventType":"security.request.blocked","displayMessage":"Blacklisted request from IP: 8.8.8.8, Proxy Type: tor, ASN: 41281","debugContext":{"debugData":{"url":"/home/potato","requestUri":"/home/pancakes","requestId":"8675309"}},"client":{"zone":"null","userAgent":{"rawUserAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36","os":"Windows 10","browser":"CHROME"},"ipAddress":"8.8.8.8","device":"Computer"},"authenticationContext":{"authenticationStep":"0"},"actor":{"type":"SystemPrincipal","id":"8675309","displayName":"Okta System","alternateId":"system@okta.com"},"SOURCE":"s_okta-system-log","PROGRAM":"okta-system-log_relayer","HOST_FROM":"example.host","HOST":"example.host"}

##OKTA REQUEST FROM SUSPICIOUS ACTOR
alert any any any -> any any (msg: "[OKTA] REQUEST FROM SUSPICIOUS ACTOR"; content:"Request from suspicious actor"; normalize; parse_proto; parse_port; parse_src_ip: 1; parse_dst_ip: 2; default_proto: tcp; classtype: network-event; threshold: type suppress, track by_src, count 1, seconds 14400; reference: url,https://okta.github.io/okta-help/en/prod/Content/Topics/Security/threat-insight/configure-threatinsight.htm; sid:XXXXX; rev:1;)
##Auto Comment: 'Request from suspicious actor observed from source <ip>SRCIP</ip> (NAT'd source " XXX_ipChain1_XXX ") to the URL "XXX_url_XXX". This traffic received a response of "XXX_result_XXX" due to "XXX_reason_XXX". Quadrant recommends determining if this is due to a configuration issue or a malicious actor.'
##Signature Playbook: 'This rule is meant to trigger once per four hours by source IP on the Okta warning log for "Request from suspicious actor". This will often be denied and will provide a reasoning such as "Password Spraying" or "Login Failures". If the result variable is something other than "DENY" indicating the traffic was indeed blocked, this should probably be treated as a critical alert. Use your best judgement. Remember to include any correlated logs that may be found on the PIE sensor for the referenced IP if this is the case.'
##Sample Logs:
##okta_system_log-19700101.log.gz:{"version":"0","uuid":"8675309-8675309-8675309-8675309","transaction":{"type":"WEB","id":"8675309"},"severity":"WARN","request":{"ipChain[1]":{"version":"V4","ip":"8.8.8.8"},"ipChain[0]":{"version":"V4","ip":"8.8.4.4"}},"published":"2022-06-02T09:53:16.314Z","outcome":{"result":"DENY","reason":"Password Spray"},"legacyEventType":"security.threat.detected","eventType":"security.threat.detected","displayMessage":"Request from suspicious actor","debugContext":{"debugData":{"url":"/app/office365/","threatSuspected":"true","threatDetections":"{\"Password Spray\":\"HIGH\"}","requestUri":"/app/office365/","requestId":"8675309"}},"client":{"zone":"null","userAgent":{"rawUserAgent":"unknown","os":"unknown","browser":"unknown"},"ipAddress":"8.8.8.8","device":"unknown"},"authenticationContext":{"authenticationStep":"0"},"actor":{"type":"IP address","id":"8.8.8.8","displayName":"8.8.8.8","alternateId":"unknown"},"SOURCE":"s_okta-system-log","PROGRAM":"okta-system-log_relayer","HOST_FROM":"example.host","HOST":"example.host"}

##OKTA USER HAS REPORTED SUSPICIOUS ACTIVITY
alert any any any -> any any (msg: "[OKTA] USER HAS REPORTED SUSPICIOUS ACTIVITY"; content:"User report suspicious activity"; normalize; parse_proto; parse_port; parse_src_ip: 1; parse_dst_ip: 2; default_proto: tcp; classtype: network-event; threshold: type suppress, track by_src, count 1, seconds 14400; reference: url,https://help.okta.com/en/prod/Content/Topics/Security/suspicious-activity-reporting.htm; sid:XXXXX; rev:1;)
##Auto Comment: 'The user "XXX_alternateId_XXX" has reported suspicious activity from the source <ip>SRCIP</ip> [XXX_city_XXX , XXX_country_XXX]. Suspicious Activity Reporting in Okta provides an end user with the option to report unrecognized activity from an account activity email notification. Quadrant recommends determining why this user reported this notification.'
##Signature Playbook: 'This rule is designed to trigger once per four hours by source IP on the "User report suspicious activity" event. As the auto-comment states, Suspicious Activity Reporting in Okta provides an end user with the option to report unrecognized activity from an account activity email notification. This alert is meant to notify the client of this event so they can investigate the issue further and is informational in nature.'
##Sample Logs:
##okta_system_log-20220607.log.gz:{"version":"0","uuid":"8675309-8675309-8675309-8675309","transaction":{"type":"WEB","id":"8675309"},"target[0]":{"type":"User","id":"8675309","displayName":"FIRSTNAME SURNAME","alternateId":"USER_PRINCIPAL_NAME"},"severity":"WARN","securityContext":{"isp":"verizon","isProxy":"false","domain":"verizon.net","asOrg":"verizon","asNumber":"701"},"request":{"ipChain[0]":{"version":"V4","ip":"8.8.8.8","geographicalContext":{"state":"STATE","postalCode":"1337","geolocation":{"lon":"XX.XXXXX","lat":"XX.XXXXX"},"country":"COUNTRY","city":"CITY"}}},"published":"2022-06-02T21:42:30.419Z","outcome":{"result":"SUCCESS"},"legacyEventType":"core.user.account.report_suspicious_activity_by_enduser","eventType":"user.account.report_suspicious_activity_by_enduser","displayMessage":"User report suspicious activity","debugContext":{"debugData":{"url":"/api/internal/users/me/report-suspicious-activity","targetEventHookIds":"8675309","suspiciousActivityTimestamp":"2022-06-02T21:19:15.793Z","suspiciousActivityOs":"Windows 10","suspiciousActivityEventType":"system.email.new_device_notification.sent_message","suspiciousActivityEventTransactionId":"8675309","suspiciousActivityEventState":"STATE","suspiciousActivityEventLongitude":"XX.XXXXX","suspiciousActivityEventLatitude":"XX.XXXXX","suspiciousActivityEventIp":"8.8.4.4","suspiciousActivityEventId":"8675309-8675309-8675309-8675309","suspiciousActivityEventCountry":"COUNTRY","suspiciousActivityEventCity":"CITY","suspiciousActivityBrowser":"CHROME","requestUri":"/api/internal/users/me/report-suspicious-activity","requestId":"8675309"}},"client":{"zone":"null","userAgent":{"rawUserAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36","os":"Windows 10","browser":"CHROME"},"ipAddress":"8.8.8.8","geographicalContext":{"state":"STATE","postalCode":"1337","geolocation":{"lon":"XX.XXXXX","lat":"XX.XXXXX"},"country":"COUNTRY","city":"CITY"},"device":"Computer"},"authenticationContext":{"externalSessionId":"8675309","authenticationStep":"0"},"actor":{"type":"User","id":"8675309","displayName":"FIRSTNAME SURNAME","alternateId":"USER_PRINCIPAL_NAME"},"SOURCE":"s_okta-system-log","PROGRAM":"okta-system-log_relayer","HOST_FROM":"example.host","HOST":"example.host"}

##OKTA INVALID SELF SERVICE RECOVERY TOKEN USED BY USER
alert any any any -> any any (msg: "[OKTA] INVALID SELF SERVICE RECOVERY TOKEN USED BY USER"; content:"Invalid self service recovery token used by user"; content:"true" normalize; parse_proto; parse_port; parse_src_ip: 1; parse_dst_ip: 2; default_proto: tcp; classtype: network-event; threshold: type suppress, track by_src, count 1, seconds 300; reference: url,https://developer.okta.com/docs/reference/api/event-types/; sid:XXXXX; rev:1;)
##Auto Comment: 'The user "XXX_alternateId_XXX" was observed attempting to use an invalid self service recovery token from source <ip>SRCIP</ip>[ XXX_location_XXX ]. Quadrant recommends determining if this is an attempted credential replay or due to a misconfiguration.'
##Signature Playbook: 'This rule is designed to trigger once per five minutes by source IP on a user attempting to use an invalid self service recovery token. This could be a means of attempted credential replay. This could also be due to a misconfiguration. This alert is meant to notify the client of this event so they can investigate the issue further and is informational in nature.'
##Sample Logs:
##okta_system_log-19700101.log.gz:{"version":"0","uuid":"8675309-8675309-8675309-8675309","transaction":{"type":"WEB","id":"8675309"},"target[0]":{"type":"User","id":"unknown","displayName":"unknown","alternateId":"unknown"},"severity":"WARN","securityContext":{"isp":"verizon","isProxy":"false","domain":".","asNumber":"8675309"},"request":{"ipChain[0]":{"version":"V4","ip":"8.8.8.8","geographicalContext":{"state":"STATE","postalCode":"1337","geolocation":{"lon":"XX.XXXXX","lat":"XX.XXXXX"},"country":"COUNTRY","city":"CITY"}}},"published":"2022-06-10T09:56:50.127Z","outcome":{"result":"FAILURE","reason":"Invalid token"},"legacyEventType":"core.user_auth.self_service.invalid_recovery_token","eventType":"user.account.use_token","displayMessage":"Invalid self service recovery token used by user","debugContext":{"debugData":{"url":"/api/v1/authn/recovery/token?","threatSuspected":"false","requestUri":"/api/v1/authn/recovery/token","requestId":"8675309","invalidToken":"8675309"}},"client":{"zone":"null","userAgent":{"rawUserAgent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36","os":"Windows 10","browser":"CHROME"},"ipAddress":"8.8.8.8","geographicalContext":{"state":"STATE","postalCode":"1337","geolocation":{"lon":"XX.XXXXX","lat":"XX.XXXXX"},"country":"COUNTRY","city":"CITY"},"device":"Computer"},"authenticationContext":{"externalSessionId":"unknown","authenticationStep":"0"},"actor":{"type":"SystemPrincipal","id":"8675309","displayName":"Okta System","alternateId":"system@okta.com"},"SOURCE":"s_okta-system-log","PROGRAM":"okta-system-log_relayer","HOST_FROM":"example.host","HOST":"example.host"}
